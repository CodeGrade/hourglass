function showQuestion(q, shouldScroll) {
  $(".question").removeClass("active");
  $("#q" + q).addClass("active");

  $(".question-page-item").removeClass("active");
  $("#nav-q" + q).addClass("active");
  if (shouldScroll) { doScrolling("#q" + q); }
}

function showPart(q, p, shouldScroll) {
  showQuestion(q, false);
  $("#q" + q + " div.part").toggleClass("active", false);
  $("#q" + q + "p" + p).toggleClass("active", true);

  $(".question nav .part-page-item").toggleClass("active", false);
  $("#nav-q" + q + "p" + p).toggleClass("active", true);

  $("#q" + q + " .CodeMirror").each(function (index, cm) {
    cm.CodeMirror.refresh();
  });
  if (shouldScroll) {
    if (p !== undefined)
      doScrolling("#q" + q + "p" + p);
    else
      doScrolling("#q" + q);
  }
}

function doScrolling(anchor) {
  var navHeight = $("nav.navbar.fixed-top").outerHeight();
  var $target = $(anchor);
  var $offset = $("<span>")
      .css("display", "block")
      .css("margin-top", -navHeight + "px")
      .css("padding-bottom", navHeight + "px")
      .css("pointer-events", "none")
      .css("z-index", "999")
      .css("visibility", "hidden")
      .css("position", "relative")
      .text(anchor);
  $target.prepend($offset);
  $offset[0].scrollIntoView();
  $offset.remove();
}


$(function() {
  $(".question-link").click(function(e) {
    // prevent "#" links from jumping to the top of the page
    e.preventDefault();
    var q = $(this).data("q");
    var p = $(this).data("p");
    if (p !== undefined) {
      showPart(q, p, !$(this).hasClass("page-link"));
    } else {
      showPart(q, 1, false);
      showQuestion(q, !$(this).hasClass("page-link"));
    }
  });

  showPart(1, 1, false);
  $(".page-link").click(function(e) {
      <% #prevent "#" links from jumping to the top of the page %>
      e.preventDefault();
  });
  $(".sourceCode").each(activateCode);
  $(".sourceCodeDisplay").each(displayCode);

  $("#toggle-paginated").click(function() {
    $("#questions").toggleClass("paginated");
    $("#questions .CodeMirror").each(function (index, cm) {
      cm.CodeMirror.refresh();
    });
  });

  $("[data-toggle='previewCode']").click(function(e) {
      e.preventDefault();
      e.stopPropagation();
      var $this = $(this);
      var $parent = $this.parent();
      var target = $($this.data('target'));
      var nextSib = target.next();
      var modal = $("#fileModal");
      var modalBody = $("#fileModalBody");
      var zombie = $("<div>").css("height", target.outerHeight());
      var select = $parent.find("select");
      modalBody.append(target.detach());
      zombie.insertBefore(nextSib);
      function onClose(e) {
          modal.find("button").off('click', onClose);
          target.detach().insertBefore(nextSib);
          zombie.remove();
          if (e.target.id == "selectFileBtn") {
              select.val(target.filePicker("instance").getSelectedHref());
          }
          modal.modal('hide');
      }
      modal.find('button').click(onClose);
      target.filePicker("instance").activateByHref(select.val());
      modal.modal('show');
      modal.one('shown.bs.modal', function() {
          target.filePicker("instance").refresh();
      });
  });
});
