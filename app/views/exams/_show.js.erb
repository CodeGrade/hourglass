$("#toggle-paginated").click(() => $("#questions").toggleClass("paginated"));
function showQuestion(q, shouldScroll) {
  $(".question").removeClass("active");
  $("#q" + q).addClass("active");

  $(".question-page-item").removeClass("active");
  $("#nav-q" + q).addClass("active");
  if (shouldScroll) { doScrolling("#q" + q); }
}

function showPart(q, p, shouldScroll) {
  showQuestion(q, false);
  $("#q" + q + " div.part").toggleClass("active", false);
  $("#q" + q + "p" + p).toggleClass("active", true);

  $(".question nav .part-page-item").toggleClass("active", false);
  $("#nav-q" + q + "p" + p).toggleClass("active", true);

  $("#q" + q + " .CodeMirror").each(function (index, cm) {
    cm.CodeMirror.refresh();
  });
  if (shouldScroll) {
    if (p !== undefined)
      doScrolling("#q" + q + "p" + p);
    else
      doScrolling("#q" + q);
  }
}

function doScrolling(anchor) {
  var navHeight = $("nav.navbar.fixed-top").outerHeight();
  var $target = $(anchor);
  var $offset = $("<span>")
      .css("display", "block")
      .css("margin-top", -navHeight + "px")
      .css("padding-bottom", navHeight + "px")
      .css("pointer-events", "none")
      .css("z-index", "999")
      .css("visibility", "hidden")
      .css("position", "relative")
      .text(anchor);
  $target.prepend($offset);
  $offset[0].scrollIntoView();
  $offset.remove();
}


$(".question-link").click(function(e) {
  // prevent "#" links from jumping to the top of the page 
  e.preventDefault();
  var q = $(this).data("q");
  var p = $(this).data("p");
  if (p !== undefined) {
    showPart(q, p, !$(this).hasClass("page-link"));
  } else {
    showPart(q, 1, false);
    showQuestion(q, !$(this).hasClass("page-link"));
  }
});

$(function () {
  showPart(1, 1, false);
  setInterval(sendExamSnapshot, 5000);
});

function sendExamSnapshot() {
  $(".CodeMirror").each(function(index, cm) {
    cm.CodeMirror.save();
  });
  const formData = $("#exam-form").serialize();
  const snapshotPath = "<%= save_snapshot_exam_path(@exam) %>";
  $.post(snapshotPath, formData, function success(data, status, xhr) {
    if (data.lockout) {
      $("#questions").remove();
      alert("You have been locked out of this exam. Please notify an instructor if this is unexpected.");
      // window.location.reload();
    }
  });
}
